{
  "Comment": "A Step Function to run Lambda with SNS notifications",
  "StartAt": "RunLambda",
  "States": {
    "RunLambda": {
      "Type": "Task",
      "Resource": "${CopyFilesLambdaArn}",
      "Next": "CheckLambdaResult",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "NotifyFailure"
        }
      ]
    },
    "CheckLambdaResult": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.raw2staging.statusCode",
          "NumericEquals": 200,
          "Next": "Success"
        }
      ],
      "Default": "NotifyFailure"
    },
    "Success": {
      "Type": "Succeed"
    },
    "NotifyFailure": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Parameters": {
        "TopicArn": "arn:aws:sns:${AWSRegion}:${AWSAccountId}:GlueJobFailureNotifications",
        "Message": {
          "Error": "An error occurred in the Step Function",
          "Details": {
            "Error.$": "$.Error",
            "Cause.$": "$.Cause"
          },
          "SourceState.$": "$$.State.Name"
        },
        "Subject": "Step Function Error Notification"
      },
      "End": true
    }
  }
}
